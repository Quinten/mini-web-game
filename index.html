<!doctype html><html lang="en"><head><meta charset="utf-8"><title>Mini web game</title><meta name="description" content><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"></head><body style="color:#fff;background:#000"> <script type="module">let e,t,n,a,i,r,o;let c=0,s=0,l=1,d=1,p=1,u=document.createElement("canvas");u.style.display="block",u.style["touch-action"]="none",u.style["user-select"]="none",u.style["-webkit-tap-highlight-color"]="transparent",u.style["-webkit-touch-callout"]="none",document.body.style.margin=0,document.body.appendChild(u);var h,m,f=Object.freeze({canvas:u,preupdate:e=>{if(c===window.innerWidth&&s===window.innerHeight)return;let{canvas:t,component:n}=e;c=window.innerWidth,s=window.innerHeight,t.style.width=c+"px",t.style.height=s+"px",t.width=c*window.devicePixelRatio,t.height=s*window.devicePixelRatio,n.minWidth/n.minHeight<(d=c/s)?(p=t.height/n.minHeight,n.width=n.minWidth*d,n.height=n.minHeight):(p=t.width/n.minWidth,n.width=n.minWidth,n.height=n.minHeight/d),n.zoom=p,n.originX=(n.width-n.minWidth)/2,n.originY=(n.height-n.minHeight)/2},pretransform:e=>{let{ctx:t}=e;t.restore(),t.save(),t.scale(p,p)},predraw:e=>{let{ctx:t}=e;t.clearRect(0,0,c,s)}});let g={},y=document.title+" Data ";var w=Object.freeze({preupdate:e=>{let{id:t,entity:n}=e;if(void 0===g[t]){let e=localStorage.getItem(y+t);null!==e&&(g[t]=e,n.data=JSON.parse(e))}},postupdate:e=>{let{id:t,entity:n}=e,a=JSON.stringify(n.data);g[t]!==a&&(g[t]=a,localStorage.setItem(y+t,a))}});let v=0,b=(c=138)=>{if(void 0===e||"running"!==e.state){if(e=new AudioContext,/(iPhone|iPad)/i.test(navigator.userAgent)&&48e3!==e.sampleRate){let t=e.createBuffer(1,1,48e3),n=e.createBufferSource();n.buffer=t,n.connect(e.destination),n.start(0),n.disconnect(),e.close(),e=new AudioContext}(n=e.createBiquadFilter()).connect(e.destination),n.type="lowpass",n.frequency.value=920,(a=e.createGain()).connect(n),a.gain.value=.8,(i=e.createDelay(60/c)).delayTime.value=60/c,(r=e.createGain()).gain.value=.25,i.connect(r),r.connect(i),(o=e.createGain()).gain.value=.5,o.connect(a),i.connect(o),t=[0,1,2,3,4,5,6,7].map(()=>{let t=e.createGain();return t.connect(a),t.connect(i),t})}},x=(e,t,n,a=120,i="triangle")=>{if("closed"===e.context.state)return;let r=t.split("+"),o=r[0].replace(/\d/g,""),c=r.reduce((e,t)=>e+1/Number(t.match(/^\d+/g)[0])*240/a,0),s=r[0].match(/\d+$/g);s=s?+s[0]:4;let l="AbBCdDeEFgGa".indexOf(o);if(-1===l)return c;let d=100*l+1200*(s-4),p=e.context.createOscillator();return p.connect(e),p.frequency.value=440,p.detune.value=d,p.type=i,e.gain.setValueAtTime(0,n),e.gain.linearRampToValueAtTime(.6,n+.03*c),e.gain.setValueAtTime(.56,n+.24*c),e.gain.setValueAtTime(.55,n+.3*c),e.gain.linearRampToValueAtTime(0,n+1.5*c),p.start(n),p.stop(n+1.5*c),c};var E=Object.freeze({preupdate:n=>{let{component:a}=n;if(!a.play)return;let{melody:i,bpm:r=120,loop:o=!1,nextNote:c=0,nextNoteTick:s=e.currentTime}=a;b(r);let l=60/r*7;for(e.currentTime>s+.35&&(c=0,s=e.currentTime);s<e.currentTime+l;){let e=x(t[v],i[c],s,r);if(v=(v+1)%t.length,c=(c+1)%i.length,s+=e,0===c&&!o){a.play=!1;break}}a.nextNote=c,a.nextNoteTick=s},initCtx:b});let j=!1,k=!1,O=e=>{let t,n,a,{canvas:i}=e,r=e.component,o=Object.keys(e.entities).map(t=>e.entities[t]).find(e=>e.canvas),c=1,s=!1,l=0,d=0,p=e=>{n=(t=i.getBoundingClientRect()).left,a=t.top,o&&(c=o.canvas.zoom/window.devicePixelRatio),l=(e.clientX-n)/c,d=(e.clientY-a)/c,r.x=l,r.y=d};i.addEventListener("pointerdown",e=>{!1!==e.isPrimary&&(p(e),r.downX=l,r.downY=d,r.justDown=!0,r.isDown=!0,s=!1,E.initCtx())}),i.addEventListener("pointermove",e=>{!1!==e.isPrimary&&p(e)}),i.addEventListener("pointerup",e=>{if(s){s=!1;return}!1!==e.isPrimary&&(p(e),r.justUp=!0,r.isDown=!1)}),i.addEventListener("pointerout",e=>{r.isDown&&(r.justUp=!0,r.isDown=!1)}),i.addEventListener("pointerenter",e=>{s=!0})};h=Object.freeze({canvas:f,data:w,pointer:Object.freeze({preupdate:e=>{!1===k&&(O(e),k=!0);let{component:t}=e;j=t.pointing,t.pointing=!1},postupdate:e=>{let{component:t,canvas:n}=e;t.justDown=!1,t.justUp=!1,j&&!t.pointing?n.style.cursor="default":!j&&t.pointing&&(n.style.cursor="pointer")}}),sound:E});var C=Object.freeze({bulb:Object.freeze({draw:e=>{let{component:t,ctx:n}=e,{x:a,y:i,width:r,height:o,fill:c}=t;n.fillStyle=c,n.fillRect(a+5*r/16,i+o/2,3*r/8,o/2),n.beginPath(),n.arc(a+r/2,i+13*o/32,13*r/32,0,2*Math.PI),n.fill()},update:e=>{let{component:t,entities:n,entity:a}=e,{pointer:i}=n.input,{x:r,y:o,width:c,height:s}=t;i.x<r||i.x>c+r||i.y<o||i.y>s+o||(i.pointing=!0,i.justUp&&void 0!==a.sound&&(a.sound.play=!0),i.justUp&&(void 0!==a.data&&void 0!==a.data.nClicks&&(a.data.nClicks=a.data.nClicks+1),n.system.states=t.next))}})}),R=Object.freeze({addIcons:e=>{let t=document.createElement("canvas");t.width=1024,t.height=1024;let n=t.getContext("2d");e?e(n):(n.fillStyle="white",n.fillRect(0,0,1024,1024),n.fillStyle="lightblue",n.fillRect(256,256,512,512));let a=t.toDataURL(),i=document.createElement("link");i.rel="icon",i.type="image/png",i.href=a,document.head.appendChild(i);let r=document.createElement("link");r.rel="apple-touch-icon",r.href=a,document.head.appendChild(r);let o=document.title,c=document.querySelector("[name=description]").getAttribute("content"),s=document.body.style.background,l=document.createElement("meta");l.name="theme-color",l.content=s,document.head.appendChild(l);let d=window.location.href,p=d.replace(/[^/]+$/,""),u=[{src:a,type:"image/png",sizes:"1024x1024"}],h=document.createElement("link");h.rel="manifest",h.href="data:application/json,"+JSON.stringify({name:o,short_name:o,description:c,background_color:s,theme_color:s,display:"standalone",start_url:d,scope:p,icons:u}),document.head.appendChild(h)}});let T=["preupdate","update","postupdate","predraw","draw","postdraw"],z={preupdate:["preupdate"],update:["update"],postupdate:["postupdate"],predraw:["pretransform","predraw"],draw:["transform","draw"],postdraw:["postdraw"]},D={},P=()=>{D={},Object.keys(z).forEach(e=>{z[e].forEach(e=>{D[e]={}})})};P();var A=Object.freeze({systems:D,systemTypes:T,subsystemTypes:z,addComponents:(e,t)=>{let n={canvas:void 0,ctx:void 0};return Object.keys(e).forEach(t=>{void 0!==e[t].canvas&&(n.canvas=e[t].canvas,n.ctx=n.canvas.getContext("2d"))}),void 0!==n.canvas||t||(["predraw","draw","postdraw"].forEach(e=>{T.splice(T.indexOf(e),1)}),P()),Object.keys(e).forEach(t=>{Object.keys(z).forEach(n=>{z[n].forEach(n=>{void 0!==e[t][n]&&(D[n][t]=e[t][n])})})}),n}}),L=Object.freeze({game:(e,t,n)=>{R.addIcons(n);let{systems:a,systemTypes:i,subsystemTypes:r,addComponents:o}=A,{canvas:c,ctx:s}=o(t),l=0,d=0,p=t=>{d=t-l,l=t;let n=[];i.forEach(i=>{e.system.states.forEach(o=>{e[o].state.entities.forEach(l=>{let p=e[l],u=Object.keys(p).some(e=>void 0!==a.transform[e]||void 0!==a.draw[e]);"draw"===i&&u&&n.push({system:e=>{s.save()},c:{}}),r[i].forEach(i=>{Object.keys(p).forEach(r=>{let u=p[r],h={entities:e,id:l,entity:p,comp:r,component:u,stateId:o,delta:d,time:t,ctx:s,canvas:c};void 0!==a[i][r]&&n.push({system:a[i][r],c:h})})}),"draw"===i&&u&&n.push({system:e=>{s.restore()},c:{}})})})}),n.forEach(e=>{let{system:t,c:n}=e;t(n)}),requestAnimationFrame(p)};p(0)}});let S=["index.html"];var W=Object.freeze({start:e=>{let t=void 0===e?"mwg":e,n=e=>{let t=new Request(e,{cache:"reload"});if("cache"in t)return t;let n=new URL(e,self.location.href);return n.search+=(n.search?"&":"")+"cachebust="+Date.now(),new Request(n)};self.addEventListener("install",e=>{e.waitUntil(caches.open(t).then(e=>e.addAll(S)).then(self.skipWaiting()))}),self.addEventListener("activate",e=>{let n=[t];e.waitUntil(caches.keys().then(e=>e.filter(e=>!n.includes(e))).then(e=>Promise.all(e.map(e=>caches.delete(e)))).then(()=>self.clients.claim()))}),self.addEventListener("fetch",e=>{e.respondWith(fetch(n(e.request.url)).then(n=>(caches.open(t).then(t=>t.put(e.request.url,n.clone())),n.clone())).catch(t=>caches.match(e.request.url)))})},PRECACHE_URLS:S});let{game:U}=L;m=Object.freeze({game:U,sw:W});var q=Object.freeze({iconDraw:e=>{e.fillStyle="white",e.fillRect(320,512,384,512),e.beginPath(),e.arc(512,416,416,0,2*Math.PI),e.fill()}}),H={};H=new URL("sw.js",import.meta.url).toString();try{"serviceWorker"in navigator&&window.addEventListener("load",e=>{navigator.serviceWorker.register(H)})}catch(e){}let N={...h,...C};m.game({system:{states:["game","test"]},game:{state:{entities:["viewport","input"]}},viewport:{canvas:{minWidth:256,minHeight:256}},input:{pointer:{}},bulboff:{bulb:{fill:"gray",x:8,y:8,width:240,height:240,next:["game","testx"]},sound:{melody:["8G3","8D3","4C3"]},data:{nClicks:0}},bulbon:{bulb:{fill:"white",x:8,y:8,width:240,height:240,next:["game","test"]},sound:{melody:["8C3","8D3","8G3+8"],play:!0},data:{nClicks:0}},test:{state:{entities:["bulboff"]}},testx:{state:{entities:["bulbon"]}}},N,q.iconDraw);</script> </body></html>